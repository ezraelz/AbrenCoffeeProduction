import{r as n,j as e,x as F,G as $,s as B,z,i as _,A as R,y as b}from"./index-CYbfX4g-.js";const O=({formData:a,onChange:m,onSubmit:c,loading:i,setFormData:s})=>{const[y,f]=n.useState(!1);return n.useEffect(()=>{(async()=>{try{const o=await F.get("/orders/shipping/retrieve/");if(o.status===200||o.status===204){const w=o.data;Object.keys(w).length>0&&(s(S=>({...S,...w})),f(!0))}}catch(o){console.error("Failed to fetch shipping address",o)}})()},[s]),e.jsxs("form",{onSubmit:c,className:"shipping-form-container",children:[e.jsx("h2",{className:"title",children:y?"Edit Shipping Information":"Shipping Information"}),e.jsxs("div",{className:"form-input-group",children:[["full_name","email","phone_number","address1","address2","street","city","state","country","zipcode"].map(l=>e.jsx("input",{type:"text",name:l,placeholder:l.replace("_"," ").toUpperCase(),value:a[l]||"",onChange:m,required:l!=="address2",className:"input"},l)),e.jsx("button",{type:"submit",disabled:i,className:"button",children:i?"Submitting...":y?"Update & Continue":"Continue to Review"})]})]})},L=({cart:a,onBack:m,onConfirm:c,loading:i})=>e.jsxs("div",{className:"review-container",children:[e.jsx("h2",{className:"review-title",children:"Review Your Order"}),e.jsxs("div",{className:"section",children:[e.jsx("h3",{className:"title",children:"Items in Cart"}),a.cart_items.map(({product:s,quantity:y,total_price:f})=>e.jsxs("div",{className:"itemRow",children:[e.jsxs("span",{children:[s.name," × ",y]}),e.jsxs("span",{children:["$",f.toFixed(2)]})]},s.id)),e.jsxs("p",{className:"total",children:["Total: $",a.total_price.toFixed(2)]})]}),e.jsxs("div",{className:"section",children:[e.jsx("button",{onClick:m,className:"backBtn",children:"Back"}),e.jsx("button",{onClick:c,disabled:i,className:"confirmBtn",children:i?"Processing...":"Confirm and Pay"})]})]});function M(a){return $({attr:{role:"img",viewBox:"0 0 24 24"},child:[{tag:"path",attr:{d:"M18.864 19.826h-4.107l-3.227-9.393-2.28 9.39H5.143L0 4.65h4.217l4.354 13.128c1.558-4.4 2.534-8.5 1.021-13.128H13.7ZM20.57 4.174a15.705 15.705 0 0 1-3.425 4.171 17.095 17.095 0 0 1 3.425 5.56A17.116 17.116 0 0 1 24 8.345a15.734 15.734 0 0 1-3.43-4.17Z"},child:[]}]})(a)}const U=({cart:a,email:m,loading:c,setLoading:i,phoneNumber:s,orderId:y})=>{const f=[{id:"stripe",label:"Stripe",icon:e.jsx(B,{})},{id:"paypal",label:"PayPal",icon:e.jsx(z,{})},{id:"swish",label:"Swish",icon:e.jsx(M,{})}],l=async()=>{try{const t=localStorage.getItem("access_token"),g=await _.post("/payment/stripe/",{email:m,amount:a.total_price},{headers:t?{Authorization:`Bearer ${t}`}:{},withCredentials:!0}),{url:r}=g.data;r?window.location.href=r:console.error("Missing Stripe redirect URL.")}catch(t){console.error(t),alert("Stripe payment failed.")}},o=async()=>{if(!(a!=null&&a.total_price)||!s){alert("Please enter your phone number and ensure the cart is loaded.");return}try{const t=localStorage.getItem("access_token"),r=(await _.post("/payment/swish/setup/",{amount:a.total_price,phone_number:s},{headers:t?{Authorization:`Bearer ${t}`}:{},withCredentials:!0})).data.approval_url;r?window.location.href=r:console.error("Approval URL is undefined.")}catch(t){console.error("Swish setup error:",t),alert("Swish setup failed. Please check your phone number and try again.")}},w=async()=>{try{const t=localStorage.getItem("access_token"),g=await _.post("/payment/paypal/setup/",{email:m,amount:a.total_price,order_id:y},{headers:t?{Authorization:`Bearer ${t}`}:{},withCredentials:!0}),{approval_url:r}=g.data;r?window.location.href=r:alert("PayPal setup failed: Missing approval URL.")}catch(t){console.error("PayPal setup error:",t),alert("Something went wrong while setting up PayPal.")}},S=async t=>{switch(i(!0),t){case"stripe":await l();break;case"paypal":await w();break;case"swish":await o();break;default:alert("Unsupported payment method")}i(!1)};return e.jsxs("div",{className:"payment-container",children:[e.jsx("h2",{className:"title",children:"Choose Payment Method"}),e.jsx("div",{className:"section",children:f.map(({id:t,label:g,icon:r})=>e.jsxs("button",{onClick:()=>S(t),disabled:c,className:"button",children:[r,e.jsx("span",{children:g})]},t))}),e.jsxs("p",{className:"total",children:["Total to Pay: $",a.total_price.toFixed(2)]})]})},q=()=>{const[a,m]=n.useState(null),[c,i]=n.useState({full_name:"",email:"",phone_number:"",address1:"",address2:"",city:"",street:"",state:"",country:"",zipcode:""}),[s,y]=n.useState(null),[f,l]=n.useState(""),[o,w]=n.useState(null),[S,t]=n.useState(!1),[g,r]=n.useState(!1),[j,v]=n.useState(0),{setShowNav:N,setShowFooter:k}=R();n.useEffect(()=>{(async()=>{try{const p=localStorage.getItem("access_token"),x=p?{Authorization:`Bearer ${p}`}:{},{data:h}=await _.get("/cart/",{headers:x,withCredentials:!0}),A={...h,cart_items:h.cart_items.map(u=>({...u,price:typeof u.price=="string"?parseFloat(u.price):u.price,total_price:u.total_price!==void 0&&u.total_price!==null?Number(u.total_price):Number(u.price)*Number(u.quantity)}))};m(A)}catch{b.error("❌ Failed to load cart data.")}})()},[]);const C=d=>{const{name:p,value:x}=d.target;i(h=>({...h,[p]:x}))},P=async d=>{d.preventDefault(),t(!0);try{const p=localStorage.getItem("access_token"),x=p?{Authorization:`Bearer ${p}`}:{},{data:h}=await _.post("/orders/shipping/create/",c,{headers:x,withCredentials:!0});y(h.id),l(h.phone_number),v(1),b.success("✅ Shipping information saved.")}catch{b.error("❌ Failed to save shipping info")}finally{t(!1)}},I=async()=>{if(!s||!a){b.error("Missing shipping address or cart.");return}t(!0);try{const d=localStorage.getItem("access_token"),p=d?{Authorization:`Bearer ${d}`}:{},{data:x}=await _.post("/orders/create/",{shipping_address_id:s,total_price:a.total_price,phone_number:c.phone_number,delivery_frequency:"none"},{headers:p,withCredentials:!0}),h=x.order_id;w(h),v(2),b.success("✅ Order created successfully!")}catch(d){console.error(d),b.error("❌ Failed to create order.")}finally{t(!1)}};return n.useEffect(()=>(N(!1),k(!1),()=>{N(!0),k(!0)}),[N,k]),e.jsx("div",{className:"checkout",children:e.jsx("div",{className:"checkout-container",children:e.jsxs("div",{className:"accordion",children:[e.jsxs("div",{className:`accordion-section ${j>=0?"active":"disabled"}`,children:[e.jsx("h2",{onClick:()=>v(0),children:"1. Shipping Information"}),j===0&&a&&e.jsx(O,{formData:c,setFormData:i,onChange:C,onSubmit:P,loading:S})]}),e.jsxs("div",{className:`accordion-section ${j>=1?"active":"disabled"}`,children:[e.jsx("h2",{onClick:()=>v(1),children:"2. Review Your Order"}),j===1&&a&&e.jsx(L,{cart:a,phoneNumber:f,shippingAddressId:s,onBack:()=>v(0),onConfirm:I,loading:S})]}),e.jsxs("div",{className:`accordion-section ${j>=2?"active":"disabled"}`,children:[e.jsx("h2",{onClick:()=>v(2),children:"3. Payment"}),j===2&&a&&o&&e.jsx(U,{cart:a,email:c.email,phoneNumber:f,loading:g,setLoading:r,orderId:o},o)]})]})})})};export{q as default};
